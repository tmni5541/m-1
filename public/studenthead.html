<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Dashboard</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300..700&family=Inconsolata:wght@200..900&family=Jost:ital,wght@0,100..900;1,100..900&family=Signika:wght@300..700&display=swap"
      rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

    <style>
      body {
        font-family: "Comfortaa", "Inconsolata", "Jost", "Signika", sans-serif;
        background-color: #2f2f2f;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      .topbar {
        background-color: #2e2e2e;
        padding: 10px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0px 2px 4px rgba(177, 177, 177, 0.1);
        position: relative;
        z-index: 2;
      }

      .topbar .search-bar {
        flex-grow: 1;
        display: flex;
        justify-content: flex-start;
        position: relative;
        padding-left: 480px;
      }

      .topbar .search-bar input {
        width: 400px;
        padding: 5px 10px 5px 35px;
        border-radius: 20px;
        border: 1px solid #717171;
        background-color: #333;
        color: #979797;
        font-size: 16px;
        position: relative;
        z-index: 1;
      }

      .topbar .search-bar .fas {
        position: absolute;
        left: 490px;
        top: 50%;
        transform: translateY(-50%);
        color: #979797;
        z-index: 2;
      }

      .topbar .user-section {
        display: flex;
        align-items: center;
        position: relative;
      }

      #user-email {
        color: white;
        font-size: 16px;
        margin-right: 10px;
      }

      .user-icon {
        cursor: pointer;
        position: relative;
      }

      .user-icon i {
        font-size: 30px;
        color: white;
      }

      .dropdown-menu {
        display: none;
        position: absolute;
        right: 0;
        top: 50px;
        background-color: #fff;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        overflow: hidden;
        z-index: 1000;
      }

      .dropdown-menu a {
        display: block;
        padding: 10px;
        color: #333;
        text-decoration: none;
        font-size: 14px;
      }

      .dropdown-menu a:hover {
        background-color: #f0f0f0;
      }

      .team-action {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        margin: 20px;
        position: relative;
        margin-left: auto;
      }

      .team-action .ellipsis {
        font-size: 18px;
        color: #fff;
        margin-right: 10px;
        cursor: pointer;
      }

      .team-action .team-button {
        display: flex;
        align-items: center;
        padding: 5px 10px;
        border: 2px solid #ccc;
        border-radius: 10px;
        background-color: white;
        cursor: pointer;
        font-size: 14px;
        color: #333;
      }

      .team-action .team-button i {
        margin-right: 5px;
        font-size: 14px;
      }

      .team-action .team-button:hover {
        background-color: #f0f0f0;
      }

      .team-menu {
        display: none;
        position: absolute;
        top: 107%;
        left: 0;
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        width: 157px;
        z-index: 1001;
      }

      .team-menu a {
        display: flex;
        align-items: center;
        padding: 10px;
        color: #333;
        text-decoration: none;
        font-size: 14px;
      }

      .team-menu a:hover {
        background-color: #f0f0f0;
      }

      .team-menu a i {
        margin-right: 5px;
      }

      .sidebar {
        width: 100px;
        background-color: #333;
        color: white;
        height: 100vh;
        padding: 20px 0;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        align-items: center;
        position: fixed;
        top: 0;
        z-index: 1;
      }

      .menu-items {
        margin-top: 40px;
        position: relative;
      }

      .sidebar a {
        display: flex;
        flex-direction: column;
        align-items: center;
        color: white;
        padding: 10px;
        text-decoration: none;
        margin-bottom: 20px;
        font-size: 12px;
        text-align: center;
      }

      .sidebar a:hover {
        background-color: #5f5f5f;
        border-radius: 4px;
        width: 80%;
        text-align: center;
      }

      .sidebar i {
        font-size: 24px;
        margin-bottom: 5px;
      }

      #searchResults {
        background-color: #4d4d4d;
        color: white;
        position: absolute;
        z-index: 1000;
        width: 400px;
        border-radius: 5px;
        max-height: 200px;
        overflow-y: auto;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        top: 38px;
      }

      #searchResults .result-item {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #555;
        display: flex;
        flex-direction: column;
        font-size: 14px;
      }

      #searchResults .result-item:hover {
        background-color: #555;
      }

      #searchResults .result-item p {
        margin: 0;
        color: #fff;
      }

      #searchResults .result-item span {
        color: #727272;
      }

      .notification-badge {
        position: absolute;
        top: 0;
        right: 25px;
        background-color: rgb(255, 157, 0);
        color: white;
        border-radius: 50%;
        padding: 2px 5px;
        font-size: 12px;
        display: none;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background-color: white;
        padding: 30px;
        border-radius: 15px;
        width: 350px;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .modal-content h2 {
        margin-bottom: 20px;
        font-size: 20px;
        color: #333;
      }

      .modal-content input {
        width: 90%;
        padding: 10px;
        margin-bottom: 15px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 14px;
      }

      .modal-content button {
        padding: 10px 20px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
      }

      .modal-content button:hover {
        background-color: #45a049;
      }

      .close {
        color: #aaa;
        align-self: flex-end;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .close:hover,
      .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }

      .error {
        color: red;
        font-size: 12px;
        margin-top: -10px;
        margin-bottom: 10px;
      }

      .classroom-list {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-start;
        /* จัดชิดซ้าย */
        padding: 0px;
        gap: 0px;
        /* ระยะห่างระหว่างห้องเรียน */
        margin-left: 105px;
        /* เว้นระยะห่างจากแถบบาร์เมนู 100px + 10px */
      }

      .classroom-item {
        width: 150px;
        height: 120px;
        padding: 15px;
        margin: 10px;
        border-radius: 10px;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        color: white;
      }

      .classroom-header {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 10px;
      }

      .classroom-icon {
        font-size: 40px;
        margin-bottom: 15px;
      }
    </style>
  </head>

  <body>
    <div class="topbar">
      <div class="search-bar">
        <i class="fas fa-search"></i>
        <input type="text" placeholder="ค้นหา (Cmd+E)" id="searchInput" />
        <div id="searchResults"></div>
      </div>
      <div class="user-section">
        <div id="user-email"></div>
        <div class="user-icon" id="userIcon">
          <i class="fas fa-user-circle"></i>
        </div>
        <div class="dropdown-menu" id="dropdownMenu">
          <a href="#">Profile</a>
          <a href="#">Log out</a>
        </div>
      </div>
    </div>

    <!-- ปุ่มธรรมดาที่เพิ่มเข้ามาพร้อมเมนู -->
    <div class="team-action">
      <div class="team-button" onclick="toggleTeamMenu()">
        <i class="fas fa-users"></i> เข้าร่วมหรือสร้างทีม
      </div>
      <div class="team-menu" id="teamMenu">
        <a href="#" onclick="openModal()"
          ><i class="fas fa-users"></i> สร้างห้องเรียน</a
        >
        <a href="#" onclick="openJoinModal()"
          ><i class="fas fa-users"></i> เข้าร่วมห้องเรียน</a
        >
      </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
      <div class="menu-items">
        <a href="studenthead.html?email="
          ><i class="fa fa-chalkboard-teacher"></i><span>Classroom</span></a
        >
        <a href="Chat.html?email="
          ><i class="fa fa-comments"></i><span>Chat</span></a
        >
        <a
          href="Notifications.html?email="
          id="notificationMenu"
          style="position: relative">
          <i class="fa fa-bell"></i>
          <span>Notifications</span>
          <!-- Badge สำหรับการแจ้งเตือน -->
          <span class="notification-badge" id="notificationBadge">0</span>
        </a>
        <a href="Assignment.html?email="
          ><i class="fa fa-tasks"></i><span>Assignment</span></a
        >
        <a href="Call.html?email="
          ><i class="fa fa-phone"></i><span>Call</span></a
        >
      </div>
    </div>

    <!-- ป๊อปอัพสำหรับสร้างห้องเรียน -->
    <div id="myModal" class="modal" style="display: none">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>Name the classroom</h2>
        <input
          type="text"
          id="teamName"
          placeholder="Classroom name (Necessary)"
          required />
        <span id="teamNameError" class="error"></span>
        <input type="text" id="subject" placeholder="Subject (If there is)" />
        <input
          type="text"
          id="description"
          placeholder="Description (If there is)" />
        <button onclick="createTeam()">Create</button>
      </div>
    </div>

    <!-- ป๊อปอัพสำหรับเข้าร่วมห้องเรียน -->
    <div id="joinModal" class="modal" style="display: none">
      <div class="modal-content">
        <span class="close" onclick="closeJoinModal()">&times;</span>
        <h2>Join a classroom with a code</h2>
        <input type="text" id="joinCode" placeholder="Enter the join code" />
        <button onclick="joinTeam()">join the classroom</button>
      </div>
    </div>

    <div id="userClassrooms" class="classroom-list">
      <!-- รายการห้องเรียนจะแสดงที่นี่ -->
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
      // Firebase configuration
      var firebaseConfig = {
        apiKey: "AIzaSyC1qX4ttFX42SzVFbg6LqjNJv9rRSepYXw",
        authDomain: "project-63a86.firebaseapp.com",
        projectId: "team-1849c",
        storageBucket: "project-63a86.appspot.com",
        messagingSenderId: "448111875731",
        appId: "1:448111875731:web:6180e0c46cc10593051f66",
        measurementId: "G-SR4EFC2VFC",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      var db = firebase.firestore();

      // ดึงพารามิเตอร์จาก URL
      const urlParams = new URLSearchParams(window.location.search);
      const email = urlParams.get("email");

      // ตรวจสอบและแสดงอีเมลที่มุมขวาบน
      if (email) {
        document.getElementById("user-email").textContent = email;

        // อัปเดตลิงก์ใน Sidebar ด้วยอีเมล
        document.querySelectorAll(".menu-items a").forEach((link) => {
          const url = new URL(link.href);
          url.searchParams.set("email", email);
          link.href = url.toString();
        });
      }
      // เรียกฟังก์ชันเพื่อโหลดการแจ้งเตือน
      loadNotificationsCount(email);

      // ตรวจสอบสถานะการล็อกอินของผู้ใช้เมื่อหน้าเว็บโหลดขึ้น
      window.onload = function () {
        firebase.auth().onAuthStateChanged((user) => {
          if (user) {
            // ผู้ใช้เข้าสู่ระบบแล้ว
            console.log("User is signed in:", user.email);

            // ใช้ email หรือ uid เพื่อทำงานอื่น ๆ
            // ตัวอย่าง: โหลดข้อมูลจาก Firestore
            loadUserData(user.uid);
            loadClassrooms(user.email);
            loadNotificationsCount(user.email);
          } else {
            // ผู้ใช้ไม่ได้เข้าสู่ระบบ
            console.log("No user is signed in.");
            // คุณสามารถเปลี่ยนเส้นทางไปยังหน้าเข้าสู่ระบบ หรือแสดงข้อความแจ้งเตือนผู้ใช้
            window.location.href = "login.html"; // เปลี่ยนเส้นทางไปยังหน้าเข้าสู่ระบบ
          }
        });
      };

      // ฟังก์ชันเพิ่มเติมที่คุณต้องการเรียกเมื่อผู้ใช้เข้าสู่ระบบ
      function loadUserData(userId) {
        db.collection("Users")
          .doc(userId)
          .get()
          .then((doc) => {
            if (doc.exists) {
              console.log("User data:", doc.data());
              // ทำงานกับข้อมูลที่ดึงมา
            } else {
              console.log("No user data found!");
            }
          })
          .catch((error) => {
            console.error("Error fetching user data:", error);
          });
      }

      function loadClassrooms(email) {
        // Logic สำหรับโหลดข้อมูลห้องเรียน
      }

      function loadNotificationsCount(email) {
        // Logic สำหรับโหลดข้อมูลการแจ้งเตือน
      }

      // Function to load user data from Firestore
      function fetchUserData(userEmail) {
        db.collection("Student")
          .where("Email", "==", userEmail)
          .get()
          .then((querySnapshot) => {
            if (querySnapshot.empty) {
              db.collection("Teacher")
                .where("Email", "==", userEmail)
                .get()
                .then((querySnapshot) => {
                  if (querySnapshot.empty) {
                    alert("Error: User information could not be retrieved.");
                    console.error(
                      "Error: User information could not be retrieved for email:",
                      userEmail
                    );
                  } else {
                    const doc = querySnapshot.docs[0];
                    const userData = doc.data();
                    console.log(
                      "User data from Teacher collection: ",
                      userData
                    );
                    // ใช้ข้อมูล userData.Role และ userData.Username ที่นี่
                  }
                })
                .catch((error) => {
                  console.error(
                    "Error fetching from Teacher collection:",
                    error
                  );
                });
            } else {
              const doc = querySnapshot.docs[0];
              const userData = doc.data();
              console.log("User data from Student collection: ", userData);
              // ใช้ข้อมูล userData.Role และ userData.Username ที่นี่
            }
          })
          .catch((error) => {
            console.error("Error fetching from Student collection:", error);
          });
      }

      function loadClassrooms() {
        const userClassrooms = document.getElementById("userClassrooms");

        db.collection("Subjects")
          .where("CreatedBy.Email", "==", email)
          .get()
          .then((querySnapshot) => {
            querySnapshot.forEach((doc) => {
              displayClassroom(doc);
            });
          })
          .catch((error) => {
            console.error(
              "Error getting classrooms created by the user: ",
              error
            );
          });

        db.collection("Subjects")
          .where("Members", "array-contains", email)
          .get()
          .then((querySnapshot) => {
            querySnapshot.forEach((doc) => {
              displayClassroom(doc);
            });
          })
          .catch((error) => {
            console.error(
              "Error getting classrooms where the user is a member: ",
              error
            );
          });
      }

      function displayClassroom(doc) {
        const data = doc.data();
        const classroomDiv = document.createElement("div");
        classroomDiv.classList.add("classroom-item");

        // Set background color based on classroom name
        classroomDiv.style.backgroundColor = generateColorFromName(
          data.ClassroomName
        );

        // Determine icon based on classroom name
        const iconClass = getClassroomIcon(data.ClassroomName);

        // Create a clickable link that redirects to general.html with parameters
        const classroomLink = document.createElement("a");
        classroomLink.href = `general.html?classroom=${encodeURIComponent(
          data.ClassroomName
        )}&email=${encodeURIComponent(email)}`;
        classroomLink.style.textDecoration = "none"; // Remove underline from the link
        classroomLink.style.color = "inherit"; // Inherit text color

        // Set the inner content of the link
        classroomLink.innerHTML = `
            <div class="classroom-icon"><i class="${iconClass}"></i></div>
            <div class="classroom-header">${data.ClassroomName}</div>
        `;

        // Append the link inside the classroom item
        classroomDiv.appendChild(classroomLink);
        document.getElementById("userClassrooms").appendChild(classroomDiv);
      }

      function generateColorFromName(name) {
        let hash = 0;
        for (let i = 0; i < name.length; i++) {
          hash = name.charCodeAt(i) + ((hash << 5) - hash);
        }
        const color = `hsl(${hash % 360}, 70%, 50%)`; // Using HSL for vibrant colors
        return color;
      }

      function getClassroomIcon(name) {
        const icons = [
          "fas fa-chart-line",
          "fas fa-desktop",
          "fas fa-laptop-code",
          "fas fa-code",
          "fas fa-paint-brush",
          "fas fa-server",
          "fas fa-square-root-alt",
          "fas fa-cubes",
          "fas fa-book",
          "fas fa-users",
          "fas fa-chalkboard-teacher",
          "fas fa-atom",
          "fas fa-biohazard",
          "fas fa-brain",
          "fas fa-bullhorn",
          "fas fa-camera",
          "fas fa-car",
          "fas fa-coffee",
          "fas fa-dragon",
          "fas fa-feather-alt",
        ];

        let hash = 0;
        for (let i = 0; i < name.length; i++) {
          hash = name.charCodeAt(i) + ((hash << 5) - hash);
        }

        const index = Math.abs(hash) % icons.length; // Calculate index based on hash
        return icons[index];
      }

      window.onload = function () {
        if (email) loadClassrooms();
      };

      // Function to load notifications count
      function loadNotificationsCount(userEmail) {
        db.collection("Notifications")
          .where("To", "==", userEmail)
          .where("isRead", "==", false) // เฉพาะการแจ้งเตือนที่ยังไม่ได้อ่าน
          .onSnapshot((snapshot) => {
            const unreadCount = snapshot.size; // นับจำนวนเอกสารที่ยังไม่ได้อ่าน

            const notificationBadge =
              document.getElementById("notificationBadge");
            if (unreadCount > 0) {
              notificationBadge.style.display = "block";
              notificationBadge.textContent = unreadCount;
            } else {
              notificationBadge.style.display = "none";
            }
          });
      }

      // Listen for changes in JoinRequests
      db.collection("JoinRequests")
        .where("Status", "==", "Pending")
        .onSnapshot((snapshot) => {
          snapshot.docChanges().forEach((change) => {
            if (change.type === "added") {
              const joinRequest = change.doc.data();
              const subjectId = joinRequest.SubjectID;
              const requesterEmail = joinRequest.RequesterEmail;

              db.collection("Subjects")
                .doc(subjectId)
                .get()
                .then((doc) => {
                  if (doc.exists) {
                    const subjectData = doc.data();
                    const ownerEmail = subjectData.CreatedBy.Email;

                    // Unique identifier for notification
                    const notificationId = `${ownerEmail}_${subjectId}_${requesterEmail}`;

                    // Check if this notification has already been processed using Firestore Query
                    db.collection("Notifications")
                      .where("To", "==", ownerEmail)
                      .where("SubjectID", "==", subjectId)
                      .where("JoinRequestId", "==", change.doc.id)
                      .get()
                      .then((querySnapshot) => {
                        if (querySnapshot.empty) {
                          db.collection("Notifications")
                            .add({
                              To: ownerEmail,
                              Message: `${requesterEmail} has requested to join your classroom.`,
                              CreatedAt:
                                firebase.firestore.FieldValue.serverTimestamp(),
                              Type: "JoinRequest",
                              SubjectID: subjectId,
                              JoinRequestId: change.doc.id,
                              isRead: false,
                            })
                            .then(() => {
                              console.log("Notification added successfully.");
                            })
                            .catch((error) => {
                              console.error(
                                "Error adding notification: ",
                                error
                              );
                            });
                        } else {
                          console.log(
                            "Notification already exists. Skipping creation."
                          );
                        }
                      })
                      .catch((error) => {
                        console.error(
                          "Error checking for existing notification: ",
                          error
                        );
                      });
                  } else {
                    console.error("Subject not found with ID:", subjectId);
                  }
                })
                .catch((error) => {
                  console.error("Error fetching subject:", error);
                });
            }
          });
        });

      function joinTeam() {
        const joinCode = document.getElementById("joinCode").value.trim();
        if (joinCode) {
          db.collection("Subjects")
            .doc(joinCode)
            .get()
            .then((doc) => {
              if (doc.exists) {
                const data = doc.data();
                const ownerEmail = data.CreatedBy.Email;

                if (ownerEmail === email) {
                  alert(
                    "You are the owner of this classroom and cannot join it."
                  );
                  return;
                }

                db.collection("JoinRequests")
                  .where("RequesterEmail", "==", email)
                  .where("SubjectID", "==", doc.id)
                  .get()
                  .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                      db.collection("JoinRequests")
                        .add({
                          JoinCode: joinCode,
                          RequesterEmail: email,
                          Status: "Pending",
                          SubjectID: doc.id,
                          RequestedAt:
                            firebase.firestore.FieldValue.serverTimestamp(),
                        })
                        .then((joinRequestDocRef) => {
                          console.log(
                            "Join request sent to the owner:",
                            ownerEmail
                          );
                          closeJoinModal();
                          alert("Join request sent successfully!");
                        })
                        .catch((error) => {
                          console.error("Error sending join request: ", error);
                          alert(
                            "An error occurred while sending the join request. Please try again."
                          );
                        });
                    } else {
                      alert(
                        "You have already requested to join this classroom."
                      );
                    }
                  })
                  .catch((error) => {
                    console.error(
                      "Error checking existing join requests: ",
                      error
                    );
                    alert(
                      "An error occurred while checking for existing join requests. Please try again."
                    );
                  });
              } else {
                alert("Invalid join code.");
              }
            })
            .catch((error) => {
              console.error("Error checking join code: ", error);
              alert(
                "An error occurred while checking the join code. Please try again."
              );
            });
        } else {
          alert("Please enter a join code.");
        }
      }

      // Function to search email or username in both Teacher and Student collections
      document
        .getElementById("searchInput")
        .addEventListener("keyup", (event) => {
          const query = event.target.value.trim().toLowerCase();
          const searchResults = document.getElementById("searchResults");
          searchResults.innerHTML = ""; // Clear previous results

          if (query !== "") {
            // Search in Student collection
            searchInCollection("Student", query, searchResults);
            // Search in Teacher collection
            searchInCollection("Teacher", query, searchResults);
          }
        });

      function searchInCollection(collectionName, query, searchResults) {
        db.collection(collectionName)
          .get()
          .then((querySnapshot) => {
            let found = false;
            querySnapshot.forEach((doc) => {
              const data = doc.data();
              if (data && data.Email) {
                // ตรวจสอบว่าอีเมลมีอยู่
                if (data.Email.toLowerCase().startsWith(query)) {
                  found = true;
                  const resultItem = document.createElement("div");
                  resultItem.classList.add("result-item");

                  const name = document.createElement("p");
                  name.textContent = data.Username
                    ? `${data.Username}`
                    : "No Username"; // จัดการกรณีที่ไม่มี Username

                  const emailSpan = document.createElement("span");
                  emailSpan.textContent = `${data.Email}`;

                  resultItem.appendChild(name);
                  resultItem.appendChild(emailSpan);

                  searchResults.appendChild(resultItem);
                }
              } else {
                console.error(
                  `Document missing required fields in ${collectionName} collection: `,
                  doc.id
                );
              }
            });

            if (!found) {
              const noResultItem = document.createElement("div");
              noResultItem.classList.add("result-item");
              noResultItem.textContent = `No results found in ${collectionName}.`;
              searchResults.appendChild(noResultItem);
            }
          })
          .catch((error) => {
            console.error(
              `Error getting documents from ${collectionName} collection: `,
              error
            );
          });
      }

      // Toggle dropdown menu
      const userIcon = document.getElementById("userIcon");
      const dropdownMenu = document.getElementById("dropdownMenu");

      userIcon.addEventListener("click", () => {
        dropdownMenu.style.display =
          dropdownMenu.style.display === "none" ||
          dropdownMenu.style.display === ""
            ? "block"
            : "none";
      });

      // Close dropdown if clicked outside
      window.addEventListener("click", function (e) {
        if (!userIcon.contains(e.target)) {
          dropdownMenu.style.display = "none";
        }
      });

      // Function to toggle team menu
      function toggleTeamMenu() {
        const teamMenu = document.getElementById("teamMenu");
        teamMenu.style.display =
          teamMenu.style.display === "block" ? "none" : "block";
      }

      // Function to open modal for creating classroom
      function openModal() {
        document.getElementById("myModal").style.display = "flex";
      }

      // Function to open modal for joining classroom
      function openJoinModal() {
        document.getElementById("joinModal").style.display = "flex";
      }

      // Function to close create modal
      function closeModal() {
        document.getElementById("myModal").style.display = "none";
      }

      // Function to close join modal
      function closeJoinModal() {
        document.getElementById("joinModal").style.display = "none";
      }

      // Close modal if clicked outside
      window.addEventListener("click", function (event) {
        const myModal = document.getElementById("myModal");
        const joinModal = document.getElementById("joinModal");

        if (event.target == myModal) {
          closeModal();
        }

        if (event.target == joinModal) {
          closeJoinModal();
        }
      });

      // Function to create team
      function createTeam() {
        const teamName = document.getElementById("teamName").value.trim();
        const subject = document.getElementById("subject").value.trim();
        const description = document.getElementById("description").value.trim();

        let isValid = true;

        if (teamName === "") {
          document.getElementById("teamNameError").textContent =
            "Classroom name is required.";
          isValid = false;
        } else {
          document.getElementById("teamNameError").textContent = "";
        }

        if (isValid) {
          // ดึงข้อมูลผู้ใช้จาก Firestore
          db.collection("Student")
            .where("Email", "==", email)
            .get()
            .then((querySnapshot) => {
              if (querySnapshot.empty) {
                db.collection("Teacher")
                  .where("Email", "==", email)
                  .get()
                  .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                      alert("Error: User information could not be retrieved.");
                      console.error(
                        "Error: User information could not be retrieved for email:",
                        email
                      );
                    } else {
                      const doc = querySnapshot.docs[0];
                      const userData = doc.data();
                      saveClassroom(
                        userData.Role,
                        userData.Username,
                        teamName,
                        subject,
                        description
                      );
                    }
                  })
                  .catch((error) => {
                    console.error(
                      "Error fetching from Teacher collection:",
                      error
                    );
                  });
              } else {
                const doc = querySnapshot.docs[0];
                const userData = doc.data();
                saveClassroom(
                  userData.Role,
                  userData.Username,
                  teamName,
                  subject,
                  description
                );
              }
            })
            .catch((error) => {
              console.error("Error fetching from Student collection:", error);
            });
        }
      }

      function saveClassroom(role, username, teamName, subject, description) {
        db.collection("Subjects")
          .add({
            ClassroomName: teamName,
            Subject: subject,
            Description: description,
            CreatedBy: {
              Role: role,
              Username: username,
              Email: email,
            },
            CreatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          })
          .then(() => {
            console.log("Team Created:", teamName, subject, description);
            document.getElementById("teamName").value = "";
            document.getElementById("subject").value = "";
            document.getElementById("description").value = "";
            closeModal();
          })
          .catch((error) => {
            console.error("Error creating document: ", error);
          });
      }
    </script>
  </body>
</html>
