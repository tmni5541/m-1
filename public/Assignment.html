<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assignment</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300..700&family=Inconsolata:wght@200..900&family=Jost:ital,wght@0,100..900;1,100..900&family=Signika:wght@300..700&display=swap"
      rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

    <style>
      body {
        font-family: "Comfortaa", "Inconsolata", "Jost", "Signika", sans-serif;
        background-color: #2f2f2f;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        /* ปิดการเลื่อนของหน้าจอหลัก */
      }

      html,
      body {
        height: 100%;
        min-height: 100%;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        background-color: #2f2f2f;
      }

      .topbar {
        background-color: #2e2e2e;
        padding: 10px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0px 2px 4px rgba(177, 177, 177, 0.1);
        position: relative;
        z-index: 2;
      }

      .topbar .search-bar {
        flex-grow: 1;
        display: flex;
        justify-content: flex-start;
        position: relative;
        padding-left: 480px;
      }

      .topbar .search-bar input {
        width: 400px;
        padding: 5px 10px 5px 35px;
        border-radius: 20px;
        border: 1px solid #717171;
        background-color: #333;
        color: #fff;
        font-size: 16px;
        position: relative;
        z-index: 1;
      }

      .topbar .search-bar .fas {
        position: absolute;
        left: 490px;
        top: 50%;
        transform: translateY(-50%);
        color: #fff;
        z-index: 2;
      }

      .topbar .user-section {
        display: flex;
        align-items: center;
        position: relative;
      }

      #user-email {
        color: white;
        font-size: 16px;
        margin-right: 10px;
      }

      .user-icon {
        cursor: pointer;
        position: relative;
      }

      .user-icon i {
        font-size: 30px;
        color: white;
      }

      .dropdown-menu {
        display: none;
        position: absolute;
        right: 0;
        top: 50px;
        background-color: #fff;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        overflow: hidden;
        z-index: 1000;
      }

      .dropdown-menu a {
        display: block;
        padding: 10px;
        color: #333;
        text-decoration: none;
        font-size: 14px;
      }

      .dropdown-menu a:hover {
        background-color: #f0f0f0;
      }

      .sidebar {
        width: 100px;
        background-color: #333;
        color: white;
        height: 100vh;
        padding: 20px 0;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        align-items: center;
        position: fixed;
        top: 0;
        z-index: 1;
      }

      .menu-items {
        margin-top: 40px;
      }

      .sidebar a {
        display: flex;
        flex-direction: column;
        align-items: center;
        color: white;
        padding: 10px;
        text-decoration: none;
        margin-bottom: 20px;
        font-size: 12px;
        text-align: center;
      }

      .sidebar a:hover {
        background-color: #5f5f5f;
        border-radius: 4px;
        width: 80%;
        text-align: center;
      }

      .sidebar i {
        font-size: 24px;
        margin-bottom: 5px;
      }

      #searchResults {
        background-color: #4d4d4d;
        color: white;
        position: absolute;
        z-index: 1000;
        width: 400px;
        border-radius: 5px;
        max-height: 200px;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        top: 38px;
      }

      #searchResults .result-item {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #555;
        display: flex;
        flex-direction: column;
        font-size: 14px;
      }

      #searchResults .result-item:hover {
        background-color: #555;
      }

      #searchResults .result-item p {
        margin: 0;
        color: #fff;
      }

      #searchResults .result-item span {
        color: #727272;
      }

      .content {
        flex-grow: 1;
        margin-left: 80px;
        padding: 20px;
        background-color: #2f2f2f;
        height: 100vh;
        /* ให้ content เต็มความสูงของหน้าจอ */
        overflow: hidden;
        /* ปิดการเลื่อนของคอนเทนเนอร์หลัก */
      }

      .tabs {
        display: flex;
        border-bottom: 1px solid #444;
        margin-bottom: 0px;
        width: 100%;
      }

      .tab {
        color: #bbb;
        cursor: pointer;
        margin-right: 10px;
        padding: 10px 20px;
      }

      .tab.active {
        color: #fff;
        border-bottom: 2px solid #fff;
      }

      .assignment-container {
        flex-grow: 1;
        overflow-y: auto;
        /* เปิดการเลื่อนในคอนเทนเนอร์ .assignment-container */
        max-height: calc(100vh - 180px);
        /* ลดพื้นที่ 100px จากความสูงหน้าจอ */
        padding: 10px;
      }

      .assignment-card {
        background-color: #3b3b3b;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }

      .assignment-card h3 {
        margin: 0;
        font-size: 16px;
        color: #fff;
      }

      .assignment-card .submission-info {
        font-size: 14px;
        color: #bbb;
        margin-top: 10px;
      }

      .assignment-card .status {
        color: #4caf50;
        font-size: 14px;
        text-align: right;
        margin-top: 10px;
      }
      /* Styling for the Create button */

      .create-button {
        background-color: #4d4d4d;
        color: white;
        border: none;
        padding: 10px 15px;
        /* ลดค่าของ padding เพื่อลดขนาดปุ่ม */
        border-radius: 5px;
        /* ลดขนาดของมุมโค้ง */
        cursor: pointer;
        font-size: 14px;
        /* ลดขนาดของฟอนต์ */
        margin-top: 15px;
        /* ขยับปุ่มลงมาจากด้านบน */
        margin-left: 20px;
        /* ขยับปุ่มไปทางขวา */
        margin-bottom: 10px;
        /* ลดระยะห่างด้านล่าง */
        width: 100px;
        /* กำหนดความกว้างของปุ่ม */
        display: none;
        /* ซ่อนไว้ตามค่าเริ่มต้น */
      }

      .create-button:hover {
        background-color: #979797;
      }
      /* โมดอล (popup) */
      /* โมดอล (popup) */

      .modal {
        display: none;
        justify-content: center;
        align-items: center;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        /* เพิ่ม overflow เพื่อให้เลื่อนเนื้อหาได้ */
      }

      .modal-content {
        background: rgb(183, 183, 183);
        width: 90%;
        /* ลดความกว้างลงเพื่อให้เหมาะกับหน้าจอ */
        max-width: 800px;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
        max-height: 90vh;
        /* เพิ่มขีดจำกัดความสูง */
        /* ให้โมดอลสามารถเลื่อนเนื้อหาได้เมื่อมีข้อมูลเยอะ */
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        /* เว้นระยะห่างระหว่างชื่อหัวข้อกับปุ่ม */
        align-items: center;
      }

      .header-buttons {
        display: flex;
        gap: 10px;
        /* ระยะห่างระหว่างปุ่ม */
        margin-left: auto;
        /* ดันปุ่มทั้งหมดไปทางขวา */
      }

      .header-buttons button {
        padding: 5px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      }

      .modal-header h2 {
        margin: 0;
      }

      .modal-header .header-buttons {
        display: flex;
        gap: 10px;
      }

      .header-buttons button {
        padding: 5px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      }

      .discard-btn {
        background-color: white;
        color: #333;
        border: 1px solid #ccc;
      }

      .save-btn {
        background-color: rgba(255, 108, 184, 0.816);
        color: #333;
        border: 1px solid #ccc;
      }

      .assign-btn {
        background-color: #b64343;
        color: white;
      }

      .close {
        font-size: 24px;
        cursor: pointer;
        margin-left: 15px;
        /* เพิ่มระยะห่างทางซ้ายของกากบาท */
      }

      .modal-body {
        margin-top: 20px;
      }

      .modal-body label {
        display: block;
        margin-top: 10px;
        font-weight: bold;
      }

      .modal-body input,
      .modal-body textarea,
      .modal-body select {
        width: 100%;
        padding: 10px;
        margin-top: 5px;
        border: 1.5px solid #909090;
        background-color: rgb(209, 209, 209);
        border-radius: 10px;
        box-sizing: border-box;
      }

      .modal-footer {
        display: flex;
        justify-content: flex-end;
        margin-top: 20px;
      }

      .modal-footer button {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-left: 10px;
      }

      #createButton {
        padding: 10px 20px;
        background-color: #4d4d4d;
        color: rgb(162, 162, 162);
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      #createButton:hover {
        background-color: #6d6d6d;
      }
      /* Styling สำหรับกล่องข้อมูล */

      .info-box {
        display: none;
        /* เริ่มต้นซ่อนกล่องนี้ */
        background-color: #333;
        color: white;
        padding: 20px;
        margin-top: 15px;
        border-radius: 8px;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
        width: 90%;
        max-width: 500px;
        margin-left: 20px;
      }

      .info-box h3 {
        margin: 0;
        font-size: 18px;
      }

      .info-box p {
        margin-top: 10px;
        font-size: 14px;
      }
      /* ตัวแปรสำหรับส่วน Assignment Card */

      :root {
        --assignment-card-bg-color: #3b3b3b;
        --assignment-card-border-radius: 8px;
        --assignment-card-padding: 15px;
        --assignment-card-box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        --assignment-card-title-color: #fff;
        --assignment-card-text-color: #bbb;
        --assignment-card-status-color: #4caf50;
        --assignment-card-width: 1280px;
        /* ความกว้างที่ต้องการ */
        --assignment-card-max-width: 1300px;
        /* กำหนด max-width เพื่อควบคุมขนาดการขยาย */
      }
      /* สไตล์สำหรับ assignment card */

      .assignment-card {
        background-color: var(--assignment-card-bg-color);
        padding: var(--assignment-card-padding);
        border-radius: var(--assignment-card-border-radius);
        box-shadow: var(--assignment-card-box-shadow);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        width: var(--assignment-card-width);
        /* ความกว้างคงที่ */
        max-width: var(--assignment-card-max-width);
        /* กำหนดขนาดกว้างสูงสุด */
        margin: 10px auto;
        /* ทำให้อยู่ตรงกลาง */
        flex-grow: 0;
        /* ป้องกันการขยายตาม container */
      }

      .assignment-card h3 {
        margin: 0;
        font-size: 20px;
        color: var(--assignment-card-title-color);
      }

      .assignment-card p {
        font-size: 14px;
        color: var(--assignment-card-text-color);
      }

      .assignment-card .status {
        color: var(--assignment-card-status-color);
        font-size: 14px;
        text-align: right;
        margin-top: 10px;
      }

      .notification-badge {
        position: absolute;
        top: 0;
        right: 25px;
        background-color: rgb(255, 157, 0);
        color: white;
        border-radius: 50%;
        padding: 2px 5px;
        font-size: 12px;
        display: none;
      }
      /* Container สำหรับรายการ Submission */

      .submission-list {
        display: flex;
        flex-direction: column;
      }
      /* การ์ดแสดง Submission */

      .submission-card {
        background-color: #3b3b3b;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 1 2px 4px rgba(0, 0, 0, 0.1);
        margin: 10px 0px 0px 10px;
        /* เพิ่มระยะห่าง ซ้าย ขวา บน ล่าง */
      }

      .submission-card p {
        font-size: 14px;
        color: #ffffff;
        margin: 0;
      }

      .submission-card .submission-info {
        font-size: 14px;
        color: #ffffff;
      }
      /* Formatting for submission and grade sections */

      .submission-card .grade-info {
        font-weight: bold;
        color: #34a853;
      }

      .submission-card .feedback-info {
        font-size: 13px;
        color: #666;
      }
      /* Date and time formatting */

      .submission-card .date-format {
        font-weight: bold;
        color: #1a73e8;
      }

      .submission-card .time-format {
        font-size: 12px;
        color: #757575;
      }
      /* Layout adjustments */

      .submission-container {
        display: flex;
        flex-direction: column;
      }

      .submission-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #f1f3f4;
        padding: 10px;
        border-radius: 6px;
        font-size: 18px;
        font-weight: bold;
        color: #202124;
      }

      .submission-header .icon {
        font-size: 20px;
        color: #5f6368;
      }
      /* Styling for the reload button */

      .reload-button {
        background-color: #1a73e8;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      }

      .reload-button:hover {
        background-color: #1669bb;
      }
      /* Styling for the notification tab */

      .notification-tab {
        background-color: #ffffff;
        border-radius: 5px;
        box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .notification-tab p {
        font-size: 14px;
        color: #333;
        margin: 0;
      }
      /* Active tab styling */

      .active-tab {
        background-color: #e6f4ea;
        color: #34a853;
        border-left: 4px solid #34a853;
        padding-left: 10px;
      }
      /* Tab layout */

      .tab-layout {
        display: flex;
        justify-content: space-between;
        padding: 15px 20px;
        background-color: #fff;
        box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
      }

      .tab-item {
        font-size: 16px;
        color: #333;
        margin-right: 20px;
        text-transform: capitalize;
        cursor: pointer;
      }

      .tab-item:hover {
        color: #1a73e8;
      }

      .tab-item.active {
        color: #1a73e8;
        font-weight: bold;
        border-bottom: 2px solid #1a73e8;
      }
      /* ข้อมูลฝั่งซ้าย (รายละเอียดการส่ง) */

      .submission-content {
        display: flex;
        padding: 10px;
        /* ลด padding เพื่อลดขนาดกล่อง */
        width: 100%;
        /* ลดขนาดความกว้างของกล่องลงเหลือ 80% ของพื้นที่ */
        max-width: 5000px;
        /* กำหนดความกว้างสูงสุดของกล่อง */
        background-color: #3b3b3b;
        /* เพิ่มสีพื้นหลังสำหรับความชัดเจน */
        border-radius: 10px;
        /* โค้งมุมเล็กน้อย */
      }

      .submission-left {
        display: flex;
        align-items: center;
        margin-left: 10px;
        /* ขยับไปทางขวาด้วยการเพิ่มระยะห่างจากขอบซ้าย */
      }

      .submission-info {
        display: flex;
        flex-direction: column;
        margin: 8px 0;
        /* เพิ่มระยะห่างบน-ล่างระหว่างข้อความ */
        line-height: 2;
        /* ปรับความสูงบรรทัดเพื่อเพิ่มระยะห่าง */
      }

      .submission-title {
        font-size: 16px;
        color: #ffffff;
      }

      .submission-date {
        font-size: 12px;
        color: #cccccc;
      }

      .submission-course {
        font-size: 12px;
        color: #b0b0b0;
      }

      .submission-right {
        margin-left: auto;
        margin-right: 0;
        /* ทำให้ชิดขอบขวา */
        display: flex;
        align-items: center;
        justify-content: flex-end;
        /* จัดเรียงเนื้อหาด้านในไปทางขวา */
      }

      .submission-status {
        font-size: 14px;
        color: #4caf50;
        background-color: #e8f5e9;
        padding: 8px 8px;
        border-radius: 5px;
        margin-right: 10px;
      }

      .turned-in {
        color: #4caf50;
      }
      /* ตัวแปรเฉพาะสำหรับการแสดงผล Upcoming */

      :root {
        --upcoming-bg-color: #333;
        --upcoming-card-bg: #444;
        --upcoming-text-color: #fff;
        --upcoming-due-date-color: #ffffff;
        --upcoming-subject-color: #bbb;
        --upcoming-border-radius: 10px;
        --upcoming-card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      /* Container สำหรับ Upcoming assignments */
      /* ปรับขนาดการ์ดงาน */

      .upcoming-container {
        margin-left: 20px;
        /* ปรับค่า margin-left ให้พอดี */
        border-radius: 10px;
      }

      .upcoming-card {
        background-color: var(--upcoming-card-bg);
        color: var(--upcoming-text-color);
        padding: 15px;
        margin-bottom: 15px;
        border-radius: var(--upcoming-border-radius);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        box-shadow: var(--upcoming-card-shadow);
      }

      .upcoming-card h3 {
        margin: 0;
        font-size: 18px;
        font-weight: bold;
      }

      .upcoming-card .due-date {
        color: var(--upcoming-due-date-color);
        font-size: 14px;
        margin-top: 12px;
      }

      .upcoming-card .subject-info {
        color: var(--upcoming-subject-color);
        font-size: 14px;
        margin-top: 5px;
      }
      /* ไอคอนด้านซ้าย */

      .upcoming-card-icon {
        background-color: #5a9;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 16px;
        margin-right: 10px;
      }
      /* Layout สำหรับวันที่และเวลาส่ง */

      .upcoming-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .upcoming-header .date-info {
        color: var(--upcoming-due-date-color);
        font-weight: bold;
      }

      .upcoming-body {
        display: flex;
        align-items: center;
      }

      .upcoming-icon {
        margin-right: 15px;
      }

      .upcoming-title {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .upcoming-subject {
        color: var(--upcoming-subject-color);
      }
    </style>
  </head>

  <body>
    <div class="topbar">
      <div class="search-bar">
        <i class="fas fa-search"></i>
        <input type="text" placeholder="ค้นหา (Cmd+E)" id="searchInput" />
        <div id="searchResults"></div>
      </div>
      <div class="user-section">
        <div id="user-email"></div>
        <div class="user-icon" id="userIcon">
          <i class="fas fa-user-circle"></i>
        </div>
        <div class="dropdown-menu" id="dropdownMenu">
          <a href="#">Profile</a>
          <a href="#">Log out</a>
        </div>
      </div>
    </div>

    <div class="content">
      <div class="tabs" id="tabsContainer"></div>
      <button id="createButton" class="create-button">Create</button>
      <div class="assignment-container" id="assignmentContainer"></div>
      <div class="upcoming-container"></div>
    </div>

    <!-- โมดอลสำหรับการสร้าง Assignment ใหม่ -->
    <div id="createModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>New Assignment</h2>
          <div class="header-buttons">
            <button class="discard-btn">Discard</button>
            <button class="save-btn">Save</button>
            <button class="assign-btn">Assign</button>
          </div>
          <span class="close">&times;</span>
        </div>
        <div class="modal-body">
          <label for="title">Title (required) :</label>
          <input type="text" id="title" placeholder="Enter assignment title" />

          <label for="instructions">Instructions :</label>
          <textarea
            id="instructions"
            placeholder="Enter instructions"></textarea>

          <label for="resources">Add resources :</label>
          <input type="file" id="resources" />

          <label for="points">Points :</label>
          <input type="number" id="points" placeholder="Enter points" />

          <label for="assignTo">Assign to :</label>
          <select id="assignTo">
            <option value="all">All students</option>
            <option value="group1">Group 1</option>
            <option value="group2">Group 2</option>
          </select>

          <label for="dueDate">Due Date :</label>
          <input type="date" id="dueDate" />

          <label for="dueTime">Time Due :</label>
          <input type="time" id="dueTime" />
        </div>
      </div>
    </div>

    <!-- กล่องข้อมูลที่ต้องการซ่อน -->
    <div id="infoBox" style="display: none">
      <p></p>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
      <div class="menu-items">
        <a href="studenthead.html?email={{email}}"
          ><i class="fa fa-chalkboard-teacher"></i><span>Classroom</span></a
        >
        <a href="Chat.html?email={{email}}"
          ><i class="fa fa-comments"></i><span>Chat</span></a
        >
        <a
          href="Notifications.html?email="
          id="notificationMenu"
          style="position: relative">
          <i class="fa fa-bell"></i>
          <span>Notifications</span>
          <!-- Badge สำหรับการแจ้งเตือน -->
          <span
            class="notification-badge"
            id="notificationBadge"
            style="display: none"
            >0</span
          >
        </a>

        <a href="Assignment.html?email={{email}}"
          ><i class="fa fa-tasks"></i><span>Assignment</span></a
        >
        <a href="Call.html?email={{email}}"
          ><i class="fa fa-phone"></i><span>Call</span></a
        >
      </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <!-- เพิ่ม SDK นี้เข้ามา -->

    <script>
      // Firebase configuration
      var firebaseConfig = {
        apiKey: "AIzaSyC1qX4ttFX42SzVFbg6LqjNJv9rRSepYXw",
        authDomain: "project-63a86.firebaseapp.com",
        projectId: "team-1849c",
        storageBucket: "team-1849c.appspot.com",
        messagingSenderId: "448111875731",
        appId: "1:448111875731:web:6180e0c46cc10593051f66",
        measurementId: "G-SR4EFC2VFC",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      var db = firebase.firestore();

      // Load email from URL and set to user-email element
      document.addEventListener("DOMContentLoaded", async function () {
        const email = new URLSearchParams(window.location.search).get("email");
        if (email) {
          document.getElementById("user-email").textContent = email;
          document.querySelectorAll(".menu-items a").forEach((link) => {
            const url = new URL(link.href);
            url.searchParams.set("email", email);
            link.href = url.toString();
          });

          // Check role from localStorage first
          const cachedRole = localStorage.getItem(`userRole_${email}`);
          if (cachedRole) {
            // If role is cached, use it directly
            updateTabsBasedOnRole(cachedRole);
          } else {
            // If not cached, fetch from Firestore and store it in localStorage
            await checkUserRole(email);
          }
        }
      });

      // Function to load notifications count
      function loadNotificationsCount(userEmail) {
        db.collection("Notifications")
          .where("To", "==", userEmail)
          .where("isRead", "==", false) // เฉพาะการแจ้งเตือนที่ยังไม่ได้อ่าน
          .onSnapshot((snapshot) => {
            const unreadCount = snapshot.size; // นับจำนวนเอกสารที่ยังไม่ได้อ่าน

            const notificationBadge =
              document.getElementById("notificationBadge");
            if (unreadCount > 0) {
              notificationBadge.style.display = "block"; // แสดง badge ถ้ามีการแจ้งเตือน
              notificationBadge.textContent = unreadCount; // แสดงจำนวนการแจ้งเตือนที่ยังไม่ได้อ่าน
            } else {
              notificationBadge.style.display = "none"; // ซ่อน badge ถ้าไม่มีการแจ้งเตือน
            }
          });
      }

      // เรียกใช้ฟังก์ชันนี้เมื่อผู้ใช้เข้าสู่ระบบหรือหน้าโหลด
      window.onload = function () {
        const userEmail = new URLSearchParams(window.location.search).get(
          "email"
        ); // ดึงอีเมลจาก URL
        if (userEmail) {
          loadNotificationsCount(userEmail); // เรียกฟังก์ชันเพื่อโหลดการแจ้งเตือน
        }
      };

      // Function to search email or username in both Teacher and Student collections
      document
        .getElementById("searchInput")
        .addEventListener("keyup", (event) => {
          const query = event.target.value.trim().toLowerCase();
          const searchResults = document.getElementById("searchResults");
          searchResults.innerHTML = ""; // Clear previous results

          if (query !== "") {
            // Search in Student collection
            searchInCollection("Student", query, searchResults);
            // Search in Teacher collection
            searchInCollection("Teacher", query, searchResults);
          }
        });

      function searchInCollection(collectionName, query, searchResults) {
        db.collection(collectionName)
          .get()
          .then((querySnapshot) => {
            let found = false;
            querySnapshot.forEach((doc) => {
              const data = doc.data();
              if (data && data.Email) {
                if (data.Email.toLowerCase().startsWith(query)) {
                  found = true;
                  const resultItem = document.createElement("div");
                  resultItem.classList.add("result-item");

                  const name = document.createElement("p");
                  name.textContent = data.Username
                    ? `${data.Username}`
                    : "No Username";

                  const emailSpan = document.createElement("span");
                  emailSpan.textContent = `${data.Email}`;

                  resultItem.appendChild(name);
                  resultItem.appendChild(emailSpan);

                  searchResults.appendChild(resultItem);
                }
              } else {
                console.error(
                  `Document missing required fields in ${collectionName} collection: `,
                  doc.id
                );
              }
            });

            if (!found) {
              const noResultItem = document.createElement("div");
              noResultItem.classList.add("result-item");
              noResultItem.textContent = `No results found in ${collectionName}.`;
              searchResults.appendChild(noResultItem);
            }
          })
          .catch((error) => {
            console.error(
              `Error getting documents from ${collectionName} collection: `,
              error
            );
          });
      }

      // Function to check user role asynchronously and store it in localStorage
      async function checkUserRole(email) {
        try {
          const querySnapshot = await db
            .collection("Subjects")
            .where("CreatedBy.Email", "==", email)
            .get();

          let userRole = "member"; // Default role
          if (!querySnapshot.empty) {
            userRole = "creator";
          }

          // Store the role in localStorage
          localStorage.setItem(`userRole_${email}`, userRole);

          // Update tabs based on role
          updateTabsBasedOnRole(userRole);
        } catch (error) {
          console.error("Error checking user role: ", error);
        }
      }
      // Function to update tabs based on user role
      function updateTabsBasedOnRole(role, documentId) {
        const tabsContainer = document.getElementById("tabsContainer");
        const createButton = document.getElementById("createButton"); // Get the create button
        tabsContainer.innerHTML = ""; // Clear existing tabs

        if (role === "creator") {
          tabsContainer.innerHTML = `
            <div class="tab active" id="assignmentTab">Assignment</div>
            <div class="tab" id="returnAssignmentTab">Return Assignment</div>
          `;

          // แสดงปุ่ม Create เฉพาะเมื่อมี Document ID
          if (documentId) {
            createButton.style.display = "inline-block"; // Show the create button
          } else {
            createButton.style.display = "none"; // Hide the create button if no documentId
          }
        } else {
          tabsContainer.innerHTML = `
            <div class="tab active" id="upcomingTab">Upcoming</div>
            <div class="tab" id="pastDueTab">Past due</div>
            <div class="tab" id="completedTab">Completed</div>
          `;
          createButton.style.display = "none"; // Hide the create button for non-creators
        }
      }

      // เปิดโมดอลเมื่อคลิกปุ่ม Create
      document
        .getElementById("createButton")
        .addEventListener("click", function () {
          const modal = document.getElementById("createModal");
          const infoBox = document.getElementById("infoBox");

          // แสดงโมดอล
          modal.style.display = "flex";
          modal.style.justifyContent = "center";
          modal.style.alignItems = "center";

          // ซ่อนกล่องข้อมูลด้านล่าง
          infoBox.style.display = "none";
        });

      // ปิดโมดอลเมื่อคลิกปุ่มปิด (x)
      document.querySelector(".close").addEventListener("click", function () {
        document.getElementById("createModal").style.display = "none";
      });

      // ปิดโมดอลเมื่อคลิกปุ่ม Discard
      document
        .querySelector(".discard-btn")
        .addEventListener("click", function () {
          document.getElementById("createModal").style.display = "none";
        });

      // ปิดโมดอลเมื่อคลิกนอกเนื้อหาของโมดอล
      window.addEventListener("click", function (event) {
        if (event.target == document.getElementById("createModal")) {
          document.getElementById("createModal").style.display = "none";
        }
      });

      document.addEventListener("DOMContentLoaded", function () {
        // ฟังก์ชันในการดึงพารามิเตอร์จาก URL
        function getQueryParameter(parameterName) {
          const urlParams = new URLSearchParams(window.location.search);
          return urlParams.get(parameterName);
        }

        // ดึงค่าต่างๆ จาก URL
        const classroomName = getQueryParameter("classroom");
        const email = getQueryParameter("email");
        const assignmentId = getQueryParameter("assignmentId"); // ดึง assignmentId หากมีการแก้ไข

        console.log("Classroom Name:", classroomName);
        console.log("Email:", email);

        const createButton = document.getElementById("createButton");

        if (classroomName) {
          // ค้นหา documentId โดยใช้ ClassroomName
          db.collection("Subjects")
            .where("ClassroomName", "==", classroomName)
            .get()
            .then(function (querySnapshot) {
              if (!querySnapshot.empty) {
                querySnapshot.forEach(function (doc) {
                  const classroomDocumentId = doc.id; // ดึงค่า documentId จาก Firestore
                  const createdByEmail = doc.data().CreatedBy.Email; // ดึง email ของผู้สร้าง
                  console.log("Document ID:", classroomDocumentId);
                  console.log("Created By Email:", createdByEmail);

                  // แสดงปุ่ม Create ถ้า email ตรงกับ email ของผู้สร้าง
                  if (email === createdByEmail) {
                    createButton.style.display = "inline-block"; // แสดงปุ่ม Create

                    // บันทึกหรือแก้ไข assignment เมื่อคลิกปุ่ม Assign
                    document
                      .querySelector(".assign-btn")
                      .addEventListener("click", function () {
                        if (assignmentId) {
                          // ถ้ามี assignmentId ให้เรียกฟังก์ชันแก้ไข
                          updateAssignment(classroomDocumentId, assignmentId);
                        } else {
                          // ถ้าไม่มี assignmentId ให้สร้าง assignment ใหม่
                          saveAssignment(classroomDocumentId);
                        }
                      });
                  } else {
                    console.log(
                      "User does not have permission to create assignments."
                    );
                  }
                });
              } else {
                console.log("No matching ClassroomName found.");
              }
            })
            .catch(function (error) {
              console.log("Error getting documents:", error);
            });
        }
      });

      // ฟังก์ชันสำหรับบันทึก assignment ใหม่ลง Firestore
      function saveAssignment(classroomDocumentId) {
        const title = document.getElementById("title").value;
        const instructions = document.getElementById("instructions").value;
        const points = document.getElementById("points").value;
        const assignTo = document.getElementById("assignTo").value;
        const dueDate = document.getElementById("dueDate").value;
        const dueTime = document.getElementById("dueTime").value;
        const fileInput = document.getElementById("resources").files[0];

        if (!title) {
          alert("กรุณากรอกชื่อของงาน");
          return;
        }

        const assignmentData = {
          title: title,
          instructions: instructions,
          points: points,
          assignTo: assignTo,
          dueDate: dueDate,
          dueTime: dueTime,
          fileUrl: "",
          createdBy: document.getElementById("user-email").textContent,
          CreatedAt: firebase.firestore.Timestamp.fromDate(new Date()),
          DocumentID: classroomDocumentId, // บันทึก DocumentID ที่เกี่ยวข้องกับ assignment นี้
        };

        // อัปโหลดไฟล์ถ้ามี
        if (fileInput) {
          const storageRef = firebase
            .storage()
            .ref("assignments/" + fileInput.name);
          const uploadTask = storageRef.put(fileInput);

          uploadTask.on(
            "state_changed",
            function (snapshot) {},
            function (error) {
              console.error("File upload error:", error);
              alert("Error uploading file. Please try again.");
            },
            function () {
              uploadTask.snapshot.ref
                .getDownloadURL()
                .then(function (downloadURL) {
                  assignmentData.fileUrl = downloadURL; // ใส่ URL ของไฟล์ลงใน assignmentData
                  addAssignmentToFirestore(assignmentData); // บันทึก assignment ลง Firestore
                });
            }
          );
        } else {
          addAssignmentToFirestore(assignmentData);
        }
      }

      // Notify all members of the assignment
      function notifyMembersForAssignment(DocumentID, assignmentData) {
        db.collection("Subjects")
          .doc(DocumentID)
          .get()
          .then((doc) => {
            if (doc.exists) {
              const members = doc.data().Members; // Get members array
              const createdBy = doc.data().CreatedBy.Email; // Get class creator email

              members.forEach((memberEmail) => {
                // Add a notification for each member
                db.collection("Notifications")
                  .add({
                    To: memberEmail,
                    Message: `You have been assigned a new task`,
                    Title: assignmentData.title,
                    Type: "Assignment",
                    instructions: assignmentData.instructions,
                    points: assignmentData.points,
                    assignTo: assignmentData.assignTo,
                    dueDate: assignmentData.dueDate,
                    dueTime: assignmentData.dueTime,
                    fileUrl: assignmentData.fileUrl,
                    createdBy: assignmentData.createdBy,
                    CreatedAt: firebase.firestore.Timestamp.fromDate(
                      new Date()
                    ), // แก้ไขฟิลด์นี้
                    DocumentID: assignmentData.DocumentID,
                    AssignmentID: assignmentData.AssignmentID, // บันทึก AssignmentID ที่ได้มาจาก Firestore
                    isRead: false, // Initially set to unread
                  })
                  .then(() => {
                    console.log(`Notification sent to ${memberEmail}`);
                  })
                  .catch((error) => {
                    console.error("Error sending notification: ", error);
                  });
              });
            } else {
              console.error(
                "No such document for classroom with Document ID:",
                DocumentID
              );
            }
          })
          .catch((error) => {
            console.error("Error getting classroom document:", error);
          });
      }

      // ฟังก์ชันสำหรับบันทึก assignment ใหม่ลง Firestore พร้อมแจ้งเตือน
      function addAssignmentToFirestore(assignmentData) {
        db.collection("Assignments")
          .add(assignmentData)
          .then(function (docRef) {
            console.log("Assignment added with ID: ", docRef.id);

            // แจ้งเตือนสมาชิกในห้องเรียน
            notifyMembersForAssignment(assignmentData.DocumentID, {
              ...assignmentData,
              AssignmentID: docRef.id, // เพิ่ม AssignmentID ที่สร้างขึ้นใหม่
            });

            alert("Assignment saved successfully!");
            resetForm(); // รีเซ็ตฟอร์มหลังจากบันทึกสำเร็จ
            document.getElementById("createModal").style.display = "none"; // ปิด modal หลังบันทึกเสร็จ
          })
          .catch(function (error) {
            console.error("Error adding assignment: ", error);
          });
      }

      // ฟังก์ชันเพื่อแสดง assignments ทั้งหมด
      function getAssignmentsByUser(userEmail) {
        db.collection("Assignments")
          .where("createdBy", "==", userEmail)
          .get()
          .then((querySnapshot) => {
            if (querySnapshot.empty) {
              console.log("No assignments found for this user.");
            } else {
              const assignmentContainer = document.getElementById(
                "assignmentContainer"
              );
              assignmentContainer.innerHTML = ""; // ล้างข้อมูลเก่าก่อน

              querySnapshot.forEach((doc) => {
                const assignmentData = doc.data();
                console.log(doc.id, " => ", assignmentData);

                // สร้าง HTML ของ assignment card
                const assignmentCard = document.createElement("div");
                assignmentCard.classList.add("assignment-card");

                assignmentCard.innerHTML = `
            <h3>${assignmentData.title}</h3>
            <p>กำหนดส่ง: ${assignmentData.dueDate} ${assignmentData.dueTime}</p>
            <p>Points: ${assignmentData.points}</p>
            <p>Instructions: ${assignmentData.instructions}</p>
            <!-- ปุ่มแก้ไข -->
            <i class="fas fa-edit edit-assignment" data-id="${doc.id}"></i>
          `;

                // เพิ่ม assignment card ลงใน container
                assignmentContainer.appendChild(assignmentCard);
              });

              // หลังจากสร้างปุ่มทั้งหมดแล้ว ผูกเหตุการณ์ให้ปุ่มแก้ไขทำงาน
              setupEditButtons();
            }
          })
          .catch((error) => {
            console.log("Error getting assignments: ", error);
          });
      }

      // ฟังก์ชันในการผูกเหตุการณ์คลิกให้กับปุ่มแก้ไขทั้งหมด
      function setupEditButtons() {
        const editButtons = document.querySelectorAll(".edit-assignment");

        editButtons.forEach((button) => {
          button.addEventListener("click", function () {
            const assignmentId = this.getAttribute("data-id");
            openEditModal(assignmentId); // เรียกใช้ฟังก์ชันเปิดโมดอลเพื่อแก้ไข assignment
          });
        });
      }

      // ฟังก์ชันเปิดโมดอลแก้ไข assignment
      function openEditModal(assignmentId) {
        // ดึงข้อมูลจาก Firestore ตาม assignmentId
        db.collection("Assignments")
          .doc(assignmentId)
          .get()
          .then((doc) => {
            if (doc.exists) {
              const data = doc.data();

              // เติมข้อมูลลงในฟอร์มแก้ไข
              document.getElementById("title").value = data.title;
              document.getElementById("instructions").value = data.instructions;
              document.getElementById("points").value = data.points;
              document.getElementById("dueDate").value = data.dueDate;
              document.getElementById("dueTime").value = data.dueTime;

              // แสดงโมดอล
              const modal = document.getElementById("createModal");
              modal.style.display = "flex";
              modal.style.justifyContent = "center";
              modal.style.alignItems = "center";

              // ลบ Event Listener เก่าที่เคยถูกเพิ่มแล้ว
              const saveBtn = document.querySelector(".save-btn");
              saveBtn.replaceWith(saveBtn.cloneNode(true)); // รีเซ็ต event listener เดิมทั้งหมด
              const newSaveBtn = document.querySelector(".save-btn");

              // เพิ่ม Event Listener สำหรับการบันทึกการแก้ไข
              newSaveBtn.addEventListener("click", function () {
                const title = document.getElementById("title").value;
                const instructions =
                  document.getElementById("instructions").value;
                const points = document.getElementById("points").value;
                const dueDate = document.getElementById("dueDate").value;
                const dueTime = document.getElementById("dueTime").value;
                const assignTo = document.getElementById("assignTo").value; // เพิ่มการดึง assignTo
                const fileInput = document.getElementById("resources").files[0]; // ดึงไฟล์ที่แนบมา (ถ้ามี)

                // ตรวจสอบข้อมูลก่อนการบันทึก
                if (!title || !dueDate || !dueTime) {
                  alert("กรุณากรอกข้อมูลที่จำเป็น");
                  return;
                }

                // ข้อมูลการอัปเดต Assignment ทั้งหมด
                const updatedAssignmentData = {
                  title: title,
                  instructions: instructions,
                  points: points,
                  assignTo: assignTo, // เพิ่ม assignTo
                  dueDate: dueDate,
                  dueTime: dueTime,
                  createdBy: document.getElementById("user-email").textContent,
                  UpdatedAt: firebase.firestore.Timestamp.fromDate(new Date()), // ใส่วันที่อัปเดต
                  DocumentID: data.DocumentID, // เก็บ DocumentID ของ Assignment เดิม
                  fileUrl: "", // เริ่มต้น fileUrl ว่าง
                };

                // อัปโหลดไฟล์ถ้ามี
                if (fileInput) {
                  const storageRef = firebase
                    .storage()
                    .ref("assignments/" + fileInput.name);
                  const uploadTask = storageRef.put(fileInput);

                  uploadTask.on(
                    "state_changed",
                    function (snapshot) {},
                    function (error) {
                      console.error("File upload error:", error);
                      alert("Error uploading file. Please try again.");
                    },
                    function () {
                      uploadTask.snapshot.ref
                        .getDownloadURL()
                        .then(function (downloadURL) {
                          updatedAssignmentData.fileUrl = downloadURL; // ใส่ URL ของไฟล์ลงใน updatedAssignmentData
                          updateAssignmentInFirestore(
                            assignmentId,
                            updatedAssignmentData
                          ); // อัปเดต assignment ใน Firestore

                          // อัปเดต Notifications หลังจากอัปเดต Assignment
                          updateNotificationsForAssignment(data.DocumentID, {
                            ...updatedAssignmentData,
                            AssignmentID: assignmentId,
                          });
                        });
                    }
                  );
                } else {
                  // อัปเดต Assignment ทันทีถ้าไม่มีไฟล์
                  updateAssignmentInFirestore(
                    assignmentId,
                    updatedAssignmentData
                  );

                  // อัปเดต Notifications หลังจากอัปเดต Assignment
                  updateNotificationsForAssignment(data.DocumentID, {
                    ...updatedAssignmentData,
                    AssignmentID: assignmentId,
                  });
                }
              });
            } else {
              console.log("No such document!");
            }
          })
          .catch((error) => {
            console.log("Error getting document:", error);
          });
      }

      // ฟังก์ชันอัปเดต Assignment ใน Firestore
      function updateAssignmentInFirestore(
        assignmentId,
        updatedAssignmentData
      ) {
        db.collection("Assignments")
          .doc(assignmentId)
          .update(updatedAssignmentData)
          .then(() => {
            console.log(
              "Assignment updated successfully with ID:",
              assignmentId
            );
            alert("Assignment updated successfully!");
          })
          .catch((error) => {
            console.error("Error updating assignment:", error);
          });
      }

      function updateNotificationsForAssignment(DocumentID, assignmentData) {
        db.collection("Notifications")
          .where("AssignmentID", "==", assignmentData.AssignmentID)
          .get()
          .then((querySnapshot) => {
            if (!querySnapshot.empty) {
              const promises = []; // ใช้เพื่อเก็บ promises ของการอัปเดตแต่ละครั้ง
              querySnapshot.forEach((doc) => {
                // ทำการอัปเดตแจ้งเตือนที่มี AssignmentID ตรงกัน
                const updatePromise = db
                  .collection("Notifications")
                  .doc(doc.id)
                  .update({
                    Title: assignmentData.title,
                    Message: `Assignment has been updated.`,
                    instructions: assignmentData.instructions,
                    points: assignmentData.points,
                    dueDate: assignmentData.dueDate,
                    dueTime: assignmentData.dueTime,
                    fileUrl: assignmentData.fileUrl,
                    UpdatedAt: firebase.firestore.Timestamp.fromDate(
                      new Date()
                    ), // อัปเดตวันที่
                  })
                  .then(() => {
                    console.log(
                      `Notification updated successfully for AssignmentID: ${assignmentData.AssignmentID}`
                    );
                  })
                  .catch((error) => {
                    console.error("Error updating notification:", error);
                  });

                // เพิ่ม promise ของการอัปเดตลงใน array
                promises.push(updatePromise);
              });

              // รอให้การอัปเดตทั้งหมดเสร็จสิ้น จากนั้นทำการรีเฟรชหน้าเว็บ
              Promise.all(promises).then(() => {
                console.log(
                  "All notifications updated successfully. Reloading page..."
                );
                window.location.reload(); // รีเฟรชหน้าเว็บหลังจากที่การอัปเดตเสร็จสมบูรณ์
              });
            } else {
              console.log(
                "No notifications found for this AssignmentID. No update made."
              );
            }
          })
          .catch(function (error) {
            console.error(
              "Error fetching notifications for AssignmentID:",
              error
            );
          });
      }

      // ฟังก์ชันกรองค่าที่เป็น undefined ออกจากอ็อบเจ็กต์
      function removeUndefinedFields(data) {
        return Object.fromEntries(
          Object.entries(data).filter(([key, value]) => value !== undefined)
        );
      }

      // ฟังก์ชันสำหรับรีเซ็ตฟอร์ม
      function resetForm() {
        document.getElementById("title").value = "";
        document.getElementById("instructions").value = "";
        document.getElementById("points").value = "";
        document.getElementById("assignTo").value = "all";
        document.getElementById("dueDate").value = "";
        document.getElementById("dueTime").value = "";
        document.getElementById("resources").value = ""; // รีเซ็ตไฟล์ที่อัปโหลด
      }

      // การเรียกใช้ฟังก์ชัน โดยส่ง email ของผู้ใช้เป็นพารามิเตอร์
      document.addEventListener("DOMContentLoaded", function () {
        const userEmail = new URLSearchParams(window.location.search).get(
          "email"
        );
        if (userEmail) {
          getAssignmentsByUser(userEmail);
        }
      });
      document.addEventListener("DOMContentLoaded", function () {
        const email = new URLSearchParams(window.location.search).get("email"); // ดึง email จาก URL
        const createButton = document.getElementById("createButton"); // ปุ่ม Create
        const returnAssignmentTab = document.getElementById(
          "returnAssignmentTab"
        );
        const assignmentTab = document.getElementById("assignmentTab");

        // เมื่อคลิกแท็บ Return Assignment
        if (returnAssignmentTab) {
          returnAssignmentTab.addEventListener("click", function () {
            // ลบคลาส active จากแท็บอื่น
            assignmentTab.classList.remove("active");

            // เพิ่มคลาส active ให้ Return Assignment
            returnAssignmentTab.classList.add("active");

            // ซ่อนปุ่ม Create
            createButton.style.display = "none";

            // เรียกใช้ฟังก์ชัน checkNotificationsForReturnAssignments
            if (email) {
              checkNotificationsForReturnAssignments(email);
            }
          });
        }

        // เมื่อคลิกแท็บ Assignment
        if (assignmentTab) {
          assignmentTab.addEventListener("click", function () {
            // ลบคลาส active จากแท็บอื่น
            returnAssignmentTab.classList.remove("active");

            // เพิ่มคลาส active ให้ Assignment
            assignmentTab.classList.add("active");

            // แสดงปุ่ม Create เฉพาะในเมนู Assignment
            createButton.style.display = "inline-block";

            // รีเฟรชหน้า 1 ครั้งเมื่อคลิกที่แท็บ Assignment
            location.reload();
          });
        }

        // ฟังก์ชันที่รันเมื่อคลิกเมนูอื่น (ถ้าต้องการ)
        const upcomingTab = document.getElementById("upcomingTab");
        if (upcomingTab) {
          upcomingTab.addEventListener("click", function () {
            // ซ่อนปุ่ม Create เมื่ออยู่ในเมนูอื่น
            createButton.style.display = "none";
          });
        }
      });

      document.addEventListener("DOMContentLoaded", function () {
        const email = new URLSearchParams(window.location.search).get("email");
        const returnAssignmentTab = document.getElementById(
          "returnAssignmentTab"
        );
        const assignmentTab = document.getElementById("assignmentTab");

        // เมื่อคลิกแท็บ Return Assignment
        if (returnAssignmentTab) {
          returnAssignmentTab.addEventListener("click", function () {
            // รีเซ็ตคอนโซลทุกครั้งเมื่อคลิกเมนู Return Assignment
            console.clear(); // เคลียร์คอนโซลเพื่อรีเซ็ต
            console.log("Return Assignment Tab Clicked. Console reset.");

            // ลบคลาส active จากแท็บอื่น
            assignmentTab.classList.remove("active");

            // เพิ่มคลาส active ให้ Return Assignment
            returnAssignmentTab.classList.add("active");
          });
        }

        // เมื่อคลิกแท็บ Assignment
        if (assignmentTab) {
          assignmentTab.addEventListener("click", function () {
            // ลบคลาส active จากแท็บอื่น
            returnAssignmentTab.classList.remove("active");

            // เพิ่มคลาส active ให้ Assignment
            assignmentTab.classList.add("active");

            // รีเฟรชหน้า 1 ครั้งเมื่อคลิกที่แท็บ Assignment
            location.reload();
          });
        }
      });

      document.addEventListener("DOMContentLoaded", function () {
        const email = new URLSearchParams(window.location.search).get("email");
        const currentPage = window.location.pathname.split("/").pop(); // ดึงชื่อหน้าปัจจุบัน

        if (email) {
          // ถ้าหน้าเป็น Return Assignment ถึงจะเรียกฟังก์ชันดึงข้อมูล
          if (currentPage === "ReturnAssignment.html") {
            checkNotificationsForReturnAssignments(email);
          }
        }
      });

      // ฟังก์ชันที่ตรวจสอบ Notifications และเรียกข้อมูล Submissions
      function checkNotificationsForReturnAssignments(email) {
        const notificationContainer = document.getElementById(
          "assignmentContainer"
        ); // ที่จะแสดงข้อมูลผลลัพธ์
        notificationContainer.innerHTML = ""; // เคลียร์ก่อนแสดงข้อมูลใหม่

        const submissionIds = new Set(); // ใช้ Set เพื่อเก็บ SubmissionId ที่ไม่ซ้ำกัน

        // ค้นหา Notifications ที่มี 'To' ตรงกับ email ของผู้ใช้
        db.collection("Notifications")
          .where("To", "==", email)
          .get()
          .then((querySnapshot) => {
            if (!querySnapshot.empty) {
              querySnapshot.forEach((doc) => {
                const notificationData = doc.data();

                if (notificationData.SubmissionId) {
                  // ถ้า SubmissionId ยังไม่เคยถูกดึงมา ให้ดึงข้อมูล
                  if (!submissionIds.has(notificationData.SubmissionId)) {
                    submissionIds.add(notificationData.SubmissionId); // เพิ่ม SubmissionId ลงใน Set
                    getSubmissionData(
                      notificationData.SubmissionId,
                      notificationContainer
                    );
                  }
                }
              });
            } else {
              console.log("No notifications found for this user.");
              notificationContainer.innerHTML =
                "<p>No return assignments found.</p>";
            }
          })
          .catch((error) => {
            console.error("Error getting notifications: ", error);
          });
      }

      // ฟังก์ชันในการดึงข้อมูลจาก Collection Submissions ตาม SubmissionId
      function getSubmissionData(submissionId, container) {
        db.collection("Submissions")
          .doc(submissionId)
          .get()
          .then((doc) => {
            if (doc.exists) {
              const submissionData = doc.data();

              // แสดงผลลัพธ์ที่ดึงมาในคอนโซล
              console.log("Submission Data:", submissionData);

              // แปลงเวลาจาก Firestore Timestamp เป็น Date
              const submittedAtDate = submissionData.submittedAt.toDate(); // แปลง timestamp เป็น Date object
              const formattedSubmittedAt = formatTime(submittedAtDate); // เรียกฟังก์ชันเพื่อแปลงเป็นรูปแบบเวลา AM/PM

              // ตรวจสอบฟิลด์จริงใน Firebase
              const assignmentTitle =
                submissionData.assignmentTitle || "No title";
              const courseName = submissionData.courseName || "No course";

              // แสดงผลลัพธ์ที่ดึงมาในคอนโซล
              console.log("Assignment Title:", assignmentTitle);
              console.log("Submitted At:", formattedSubmittedAt);
              console.log("Course Name:", courseName);

              // สร้าง submissionCard สำหรับแสดงผลใน DOM
              const submissionCard = document.createElement("div");
              submissionCard.classList.add("submission-card");

              // ตรวจสอบ SubmissionId ใน Collection Score
              db.collection("Score")
                .where("SubmissionId", "==", submissionId)
                .get()
                .then((querySnapshot) => {
                  let statusColor = "green"; // ตั้งค่าสีเริ่มต้นของปุ่ม

                  // ถ้าไม่พบ SubmissionId ใน Score ให้เปลี่ยนสีเป็นเหลือง
                  if (querySnapshot.empty) {
                    statusColor = "yellow";
                  }

                  submissionCard.innerHTML = `
              <div class="submission-content">
                <div class="submission-left">
                  <div class="submission-info">
                    <p class="submission-title">${submissionData.submittedBy}</p>
                    <p class="submission-date">Submitted at ${formattedSubmittedAt}</p>
                  </div>
                </div>
                <div class="submission-right">
                  <span class="submission-status turned-in" style="background-color:${statusColor};">Turned in</span>
                </div>
              </div>
            `;

                  // เพิ่มเหตุการณ์ click เพื่อพาผู้ใช้ไปยัง AssignmentDetail.html พร้อมส่ง email และ SubmissionId ผ่าน URL
                  submissionCard.addEventListener("click", () => {
                    const email = new URLSearchParams(
                      window.location.search
                    ).get("email");
                    window.location.href = `AssignmentDetail.html?email=${email}&SubmissionId=${submissionId}`;
                  });

                  // เพิ่มข้อมูลลงใน container
                  container.appendChild(submissionCard);
                })
                .catch((error) => {
                  console.error("Error checking Score collection:", error);
                });
            } else {
              console.log("No submission found with this ID:", submissionId);
            }
          })
          .catch((error) => {
            console.error("Error getting submission data:", error);
          });
      }

      // ฟังก์ชันในการแปลงเวลาให้อยู่ในรูปแบบ AM/PM
      function formatTime(dateString) {
        const date = new Date(dateString);
        let hours = date.getHours();
        const minutes = String(date.getMinutes()).padStart(2, "0");
        const ampm = hours >= 12 ? "PM" : "AM";
        hours = hours % 12;
        hours = hours ? hours : 12; // hour '0' should be '12'
        return `${hours}:${minutes} ${ampm}`;
      }

      document.addEventListener("DOMContentLoaded", function () {
        // ตรวจสอบว่าปุ่ม Upcoming มีอยู่หรือไม่ และเพิ่มการทำงาน
        const upcomingTab = document.getElementById("upcomingTab");
        const pastDueTab = document.getElementById("pastDueTab");
        const completedTab = document.getElementById("completedTab");

        // ถ้าแท็บ Upcoming ถูก active อยู่แล้ว ให้ดึงข้อมูลทันทีเมื่อหน้าโหลด
        if (upcomingTab && upcomingTab.classList.contains("active")) {
          loadUpcomingAssignments();
        }

        // ถ้ามีแท็บ Upcoming ให้เพิ่ม event listener
        if (upcomingTab) {
          upcomingTab.addEventListener("click", function () {
            // ลบคลาส active จากแท็บอื่น
            pastDueTab.classList.remove("active");
            completedTab.classList.remove("active");

            // เพิ่มคลาส active ให้ Upcoming
            upcomingTab.classList.add("active");

            // เรียกฟังก์ชันสำหรับดึงงานที่ยังไม่ถึงกำหนดส่ง
            loadUpcomingAssignments();
          });
        }

        function loadUpcomingAssignments() {
          const email = new URLSearchParams(window.location.search).get(
            "email"
          );

          if (email) {
            // ดึงข้อมูล Submissions ที่ submittedBy ตรงกับ email
            db.collection("Submissions")
              .where("submittedBy", "==", email)
              .get()
              .then((submissionSnapshot) => {
                const submittedAssignmentIds = new Set(); // เก็บ AssignmentID ของงานที่ถูกส่งแล้ว

                submissionSnapshot.forEach((doc) => {
                  const submissionData = doc.data();
                  submittedAssignmentIds.add(submissionData.assignmentId); // เก็บ assignmentId ของงานที่ส่งแล้ว
                });

                // ดึงข้อมูล Notifications หลังจากรู้ว่าผู้ใช้ส่งงานอะไรไปแล้ว
                db.collection("Notifications")
                  .where("To", "==", email)
                  .where("Type", "==", "Assignment")
                  .get()
                  .then((querySnapshot) => {
                    const assignmentContainer = document.getElementById(
                      "assignmentContainer"
                    );
                    assignmentContainer.innerHTML = ""; // ล้างข้อมูลเก่าก่อน

                    const today = new Date(); // วันที่ปัจจุบัน

                    querySnapshot.forEach((doc) => {
                      const notificationData = doc.data();
                      const title = notificationData.Title || "No title"; // ดึง title จากข้อมูล
                      const iconText = title.substring(0, 2).toUpperCase(); // ตัด 2 ตัวแรกจาก title และแปลงเป็นตัวพิมพ์ใหญ่
                      const points = notificationData.points || "No points"; // ดึง points จากข้อมูล

                      // แปลงวันที่เป็นรูปแบบ วดป
                      const dueDate = new Date(notificationData.dueDate);
                      const formattedDueDate = formatDate(
                        notificationData.dueDate
                      );

                      // ตรวจสอบว่ากำหนดส่งอยู่ในอนาคตและไม่ถูกส่งแล้ว
                      if (
                        dueDate >= today &&
                        !submittedAssignmentIds.has(
                          notificationData.AssignmentID
                        )
                      ) {
                        // สร้าง card สำหรับแสดงข้อมูล
                        const assignmentCard = document.createElement("div");
                        assignmentCard.classList.add("upcoming-card");

                        assignmentCard.innerHTML = `
                          <div class="upcoming-body">
                            <div class="upcoming-card-icon">${iconText}</div>
                            <div>
                              <h3 class="upcoming-title">${title}</h3>
                              <p class="due-date">Due at ${formattedDueDate} ${notificationData.dueTime}</p>
                              <p class="subject-info">Points : ${points} Point</p>
                            </div>
                          </div>
                        `;

                        // เพิ่ม event listener เมื่อคลิกการ์ด
                        assignmentCard.addEventListener("click", () => {
                          // นำผู้ใช้ไปที่หน้า AssignmentDetail พร้อมส่ง assignmentId และ email
                          window.location.href = `AssignmentDetail.html?email=${email}&assignmentId=${notificationData.AssignmentID}`;
                        });

                        assignmentContainer.appendChild(assignmentCard); // เพิ่ม card ลงใน container
                      }
                    });
                  })
                  .catch((error) => {
                    console.error("Error fetching notifications: ", error);
                  });
              })
              .catch((error) => {
                console.error("Error fetching submissions: ", error);
              });
          } else {
            console.error("No email found in URL.");
          }
        }

        // ฟังก์ชันสำหรับแปลงวันที่เป็นรูปแบบ วดป
        function formatDate(dateString) {
          const date = new Date(dateString);
          const day = String(date.getDate()).padStart(2, "0"); // แปลงวันเป็น 2 หลัก
          const month = String(date.getMonth() + 1).padStart(2, "0"); // แปลงเดือนเป็น 2 หลัก (เดือนใน JavaScript นับจาก 0-11)
          const year = date.getFullYear(); // ดึงปีเป็น 4 หลัก
          return `${day}/${month}/${year}`; // คืนค่ารูปแบบ วดป
        }

        // ถ้ามีแท็บ Past due ให้เพิ่ม event listener
        if (pastDueTab) {
          pastDueTab.addEventListener("click", function () {
            // ลบคลาส active จากแท็บอื่น
            upcomingTab.classList.remove("active");
            completedTab.classList.remove("active");

            // เพิ่มคลาส active ให้ Past due
            pastDueTab.classList.add("active");

            // เรียกฟังก์ชันสำหรับดึงงานที่เลยกำหนดแล้ว
            loadPastDueAssignments();
          });
        }

        function loadPastDueAssignments() {
          const email = new URLSearchParams(window.location.search).get(
            "email"
          );

          if (email) {
            // ดึงข้อมูล Submissions ที่ submittedBy ตรงกับ email
            db.collection("Submissions")
              .where("submittedBy", "==", email)
              .get()
              .then((submissionSnapshot) => {
                const submittedAssignmentIds = new Set(); // เก็บ AssignmentID ของงานที่ถูกส่งแล้ว

                submissionSnapshot.forEach((doc) => {
                  const submissionData = doc.data();
                  submittedAssignmentIds.add(submissionData.assignmentId); // เก็บ assignmentId ของงานที่ส่งแล้ว
                });

                // ดึงข้อมูล Notifications หลังจากรู้ว่าผู้ใช้ส่งงานอะไรไปแล้ว
                db.collection("Notifications")
                  .where("To", "==", email)
                  .where("Type", "==", "Assignment")
                  .get()
                  .then((querySnapshot) => {
                    const assignmentContainer = document.getElementById(
                      "assignmentContainer"
                    );
                    assignmentContainer.innerHTML = ""; // ล้างข้อมูลเก่าก่อน

                    const today = new Date(); // วันที่ปัจจุบัน

                    querySnapshot.forEach((doc) => {
                      const notificationData = doc.data();
                      const title = notificationData.Title || "No title"; // ดึง title จากข้อมูล
                      const iconText = title.substring(0, 2).toUpperCase(); // ตัด 2 ตัวแรกจาก title และแปลงเป็นตัวพิมพ์ใหญ่
                      const points = notificationData.points || "No points"; // ดึง points จากข้อมูล

                      // แปลงวันที่เป็นรูปแบบ วดป
                      const dueDate = new Date(notificationData.dueDate);
                      const formattedDueDate = formatDate(
                        notificationData.dueDate
                      );

                      // ตรวจสอบว่ากำหนดส่งอยู่ในอดีตและไม่ถูกส่งแล้ว
                      if (
                        dueDate < today && // งานที่เลยกำหนดส่งแล้ว
                        !submittedAssignmentIds.has(
                          notificationData.AssignmentID
                        ) // งานที่ยังไม่ได้ส่ง
                      ) {
                        // สร้าง card สำหรับแสดงข้อมูล
                        const assignmentCard = document.createElement("div");
                        assignmentCard.classList.add("upcoming-card");

                        assignmentCard.innerHTML = `
                          <div class="upcoming-body">
                            <div class="upcoming-card-icon">${iconText}</div>
                            <div>
                              <h3 class="upcoming-title">${title}</h3>
                              <p class="due-date">Due at ${formattedDueDate} ${notificationData.dueTime}</p>
                              <p class="subject-info">Points: ${points}</p>
                            </div>
                          </div>
                        `;

                        assignmentContainer.appendChild(assignmentCard); // เพิ่ม card ลงใน container

                        // เพิ่ม event listener เมื่อคลิกที่การ์ด
                        assignmentCard.addEventListener("click", () => {
                          window.location.href = `AssignmentDetail.html?email=${email}&assignmentId=${notificationData.AssignmentID}`;
                        });
                      }
                    });
                  })
                  .catch((error) => {
                    console.error("Error fetching notifications: ", error);
                  });
              })
              .catch((error) => {
                console.error("Error fetching submissions: ", error);
              });
          } else {
            console.error("No email found in URL.");
          }
        }

        // ถ้ามีแท็บ Completed ให้เพิ่ม event listener
        if (completedTab) {
          completedTab.addEventListener("click", function () {
            // ลบคลาส active จากแท็บอื่น
            upcomingTab.classList.remove("active");
            pastDueTab.classList.remove("active");

            // เพิ่มคลาส active ให้ Completed
            completedTab.classList.add("active");

            // เรียกฟังก์ชันสำหรับดึงงานที่ทำเสร็จแล้ว
            loadCompletedAssignments();
          });
        }
      });

      function loadCompletedAssignments() {
        const email = new URLSearchParams(window.location.search).get("email");

        if (email) {
          console.log("Email from URL: ", email); // ตรวจสอบ email ใน console

          // ดึงข้อมูล Submissions ที่ submittedBy ตรงกับ email
          db.collection("Submissions")
            .where("submittedBy", "==", email)
            .get()
            .then((submissionSnapshot) => {
              const submittedAssignmentIds = new Set(); // เก็บ AssignmentID ของงานที่ถูกส่งแล้ว

              submissionSnapshot.forEach((doc) => {
                const submissionData = doc.data();
                submittedAssignmentIds.add(submissionData.assignmentId); // เก็บ assignmentId ของงานที่ส่งแล้ว
              });

              if (submittedAssignmentIds.size > 0) {
                // ดึงข้อมูล Assignments ทั้งหมดจาก Firestore
                db.collection("Assignments")
                  .get()
                  .then((assignmentSnapshot) => {
                    const assignmentContainer = document.getElementById(
                      "assignmentContainer"
                    );
                    assignmentContainer.innerHTML = ""; // ล้างข้อมูลเก่าก่อน

                    assignmentSnapshot.forEach((assignmentDoc) => {
                      const assignmentData = assignmentDoc.data();
                      const assignmentId = assignmentDoc.id;

                      // ตรวจสอบว่า assignmentId มีอยู่ใน Submissions หรือไม่
                      if (submittedAssignmentIds.has(assignmentId)) {
                        const title = assignmentData.title || "No title"; // ดึง title จากข้อมูล
                        const iconText = title.substring(0, 2).toUpperCase(); // ตัด 2 ตัวแรกจาก title และแปลงเป็นตัวพิมพ์ใหญ่
                        const points = assignmentData.points || "No points"; // ดึง points จากข้อมูล

                        // แปลงวันที่เป็นรูปแบบ วดป
                        const formattedDueDate = formatDate(
                          assignmentData.dueDate
                        );

                        // สร้างการ์ดสำหรับแสดงข้อมูล assignment
                        const assignmentCard = document.createElement("div");
                        assignmentCard.classList.add("upcoming-card"); // ใช้คลาสการ์ดเหมือนกับฟังก์ชันอื่น

                        assignmentCard.innerHTML = `
                                            <div class="upcoming-body">
                                                <div class="upcoming-card-icon">${iconText}</div>
                                                <div>
                                                    <h3 class="upcoming-title">${title}</h3>
                                                    <p class="due-date">Due on ${formattedDueDate}</p>
                                                    <p class="subject-info">Points: ${points}</p>
                                                </div>
                                            </div>
                                        `;

                        assignmentContainer.appendChild(assignmentCard); // เพิ่มการ์ดลงใน container

                        // เพิ่ม event listener เมื่อคลิกที่การ์ด
                        assignmentCard.addEventListener("click", () => {
                          window.location.href = `AssignmentDetail.html?email=${email}&assignmentId=${assignmentId}`;
                        });
                      }
                    });
                  })
                  .catch((error) => {
                    console.error("Error fetching assignments: ", error);
                  });
              } else {
                console.log("No completed assignments found for this user.");
                const assignmentContainer = document.getElementById(
                  "assignmentContainer"
                );
                assignmentContainer.innerHTML =
                  "<p>No completed assignments found.</p>"; // แสดงข้อความเมื่อไม่มีงานที่ทำเสร็จแล้ว
              }
            })
            .catch((error) => {
              console.error("Error fetching submissions: ", error);
            });
        } else {
          console.error("No email found in URL.");
        }
      }

      // ฟังก์ชันสำหรับแปลงวันที่ให้อยู่ในรูปแบบที่อ่านง่าย
      function formatDate(dateString) {
        const date = new Date(dateString);
        const day = String(date.getDate()).padStart(2, "0");
        const month = String(date.getMonth() + 1).padStart(2, "0"); // เดือนเริ่มต้นจาก 0
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      }
    </script>
  </body>
</html>
